---
- name: Ensure ~/.docker exists
  file:
    path: "~/.docker"
    state: directory
    owner: "{{ item.username }}"
    group: "{{ item.group }}"
    mode: 0770
  become_user: "{{ item.username }}"
  loop: "{{ proxy_docker_users }}"

- name: Update ~/.docker/config.json
  template:
    src: config.json.j2
    dest: ~/.docker/config.json
    owner: "{{ item.username }}"
    group: "{{ item.group }}"
    mode: 0770
  become_user: "{{ item.username }}"
  loop: "{{ proxy_docker_users }}"

- block:
    - name: Create folder for systemd proxy config
      file:
        path: /etc/systemd/system/docker.service.d
        state: directory
        owner: root
        group: root
        mode: 0744

    - name: Create http-proxy.conf
      template:
        src: http-proxy.conf.j2
        dest: /etc/systemd/system/docker.service.d/http-proxy.conf
        mode: 0644
        owner: root
        group: root
      notify: restart docker
  when: proxy_docker_update_systemd|bool
