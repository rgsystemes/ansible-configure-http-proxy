---
- name: Verify
  hosts: instance
  gather_facts: no
  environment: "{{ proxy_env }}"

  vars:
    proxy_env:
      HTTP_PROXY: http://proxy:3128
      HTTPS_PROXY: https://proxy:3128

  tasks:
    - name: Curl with proxy
      uri:
        url: https://github.com
        method: GET
        return_content: yes
      register: curl_output

    - name: Ensure curl returned ok
      assert:
        that: curl_output.status == 200

    - name: Run the equivalent of "apt-get update"
      apt:
        update_cache: yes

    - name: Ensure npm proxy config exists
      block:
        - name: Check for npm config
          stat:
            path: /root/.npmrc
          register: npmrc_output

        - name: Ensure file is present 
          assert:
            that: npmrc_output.stat.exists
    
    - name: Update npm using npm itself
      npm:
        name: npm
        global: yes
        state: latest
      tags: ['skip_ansible_lint']

    - name: Run git clone using HTTPS protocol
      git:
        repo: https://github.com/ansible/awx.git
        dest: /opt/awx
        version: 19.3.0

    - name: Run pip install --upgrade
      pip:
        name: 
          - pip
          - certbot
        state: latest
        executable: /usr/bin/pip3
      tags: ['skip_ansible_lint']

    - name: Update PECL channel
      shell: pecl channel-update pecl.php.net
      args:
        executable: /bin/bash
        warn: no

    - name: Check squid access logs
      lineinfile: 
        path: /var/log/squid/access.log 
        line: "{{ item }}"
        state: present
      become: yes
      loop: 
        - github
        - pecl
        - npmjs
        - pypi.org
      delegate_to: 127.0.0.1
